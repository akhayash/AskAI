# AdvancedConditionalWorkflow UI Demo ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

AdvancedConditionalWorkflow ã® WebUI ãƒ‡ãƒ¢ã¯ã€Next.js ã¨ WebSocket ã‚’ä½¿ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         WebSocket (ws://localhost:8080)         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
â”‚  Next.js UI         â”‚                                                 â”‚  .NET Backend       â”‚
â”‚  (port 3000)        â”‚                                                 â”‚  Workflow Engine    â”‚
â”‚                     â”‚                                                 â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                                           â”‚
        â”‚                                                                           â”‚
        â–¼                                                                           â–¼
   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ©ã‚¦ã‚¶                                                            Azure OpenAI
```

### é€šä¿¡ãƒ•ãƒ­ãƒ¼

1. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹**: Backend â†’ UI (workflow_start)
2. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™ºè©±**: Backend â†’ UI (agent_utterance)
3. **ãƒªã‚¹ã‚¯è©•ä¾¡**: Backend â†’ UI (agent_utterance with risk score)
4. **HITLè¦æ±‚**: Backend â†’ UI (hitl_request)
5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å¿œç­”**: UI â†’ Backend (hitl_response)
6. **æœ€çµ‚æ±ºå®š**: Backend â†’ UI (final_response)
7. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†**: Backend â†’ UI (workflow_complete)

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- .NET 8 SDK
- Node.js 20.x ä»¥é™
- npm 10.x ä»¥é™
- Azure OpenAI API ã‚¢ã‚¯ã‚»ã‚¹

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

#### Backend

```bash
cd src/AdvancedConditionalWorkflow
# appsettings.Development.json ã‚’è¨­å®š
```

#### UI

```bash
cd ui
npm install
```

## å®Ÿè¡Œæ–¹æ³•

### é–‹ç™ºãƒ¢ãƒ¼ãƒ‰

#### ã‚¹ãƒ†ãƒƒãƒ— 1: Backend ã‚’ WebSocket ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•

```bash
cd src/AdvancedConditionalWorkflow
dotnet run -- --websocket
```

å‡ºåŠ›ä¾‹:
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Advanced Conditional Workflow ãƒ‡ãƒ¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: WEBSOCKET
ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªè¨­å®š: OTLP Endpoint = http://localhost:4317
âœ“ WebSocketã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº† (Port: 8080)
```

#### ã‚¹ãƒ†ãƒƒãƒ— 2: UI ã‚’èµ·å‹• (åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«)

```bash
cd ui
npm run dev
```

#### ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹

http://localhost:3000 ã‚’é–‹ã

### æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰

#### UI ãƒ“ãƒ«ãƒ‰

```bash
cd ui
npm run build
npm run start
```

## UI æ©Ÿèƒ½

### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

#### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™ºè©±

- **ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã®é ­æ–‡å­—
- **Phase ã‚¿ã‚°**: ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º (Phase 2: Specialist Review ãªã©)
- **ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢**: è‰²åˆ†ã‘è¡¨ç¤º
  - ğŸŸ¢ Low (â‰¤30): ç·‘
  - ğŸŸ¡ Medium (31-70): é»„
  - ğŸ”´ High (>70): èµ¤
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚åˆ»

#### æœ€çµ‚æ±ºå®š

- ç‰¹åˆ¥ãªãƒã‚¤ãƒ©ã‚¤ãƒˆã‚«ãƒ¼ãƒ‰
- JSON å½¢å¼ã®è©³ç´°è¡¨ç¤º
- æ„æ€æ±ºå®šã‚µãƒãƒªãƒ¼

### 2. HITL (Human-in-the-Loop) æ‰¿èª

#### æ‰¿èªãƒ‘ãƒãƒ«

- **å¥‘ç´„æƒ…å ±è¡¨ç¤º**: JSON å½¢å¼
- **ãƒªã‚¹ã‚¯è©•ä¾¡è¡¨ç¤º**: ã‚¹ã‚³ã‚¢ã¨æ‡¸å¿µäº‹é …
- **æ‰¿èª/å´ä¸‹ãƒœã‚¿ãƒ³**:
  - âœ… Approve (Y): æ‰¿èª
  - âŒ Reject (N): å´ä¸‹

#### å‹•ä½œ

1. Backend ã‹ã‚‰ `hitl_request` ã‚’å—ä¿¡
2. UI ã«æ‰¿èªãƒ‘ãƒãƒ«ãŒè¡¨ç¤º (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã)
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. UI ãŒ `hitl_response` ã‚’ Backend ã«é€ä¿¡
5. Backend ãŒå‡¦ç†ã‚’ç¶™ç¶š

### 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼

- **æ¥ç¶šçŠ¶æ…‹**: ç·‘ (æ¥ç¶š) / èµ¤ (åˆ‡æ–­)
- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹**: é–‹å§‹/å®Ÿè¡Œä¸­/å®Œäº†

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»•æ§˜

### agent_utterance

```json
{
  "type": "agent_utterance",
  "agentName": "Legal Agent",
  "content": "æ³•çš„ãƒªã‚¹ã‚¯ã®è©•ä¾¡çµæœ...",
  "phase": "Phase 2: Specialist Review",
  "riskScore": 45,
  "timestamp": "2025-11-01T00:00:00Z",
  "messageId": "uuid"
}
```

### final_response

```json
{
  "type": "final_response",
  "decision": {
    "Decision": "Approved",
    "FinalRiskScore": 30,
    "DecisionSummary": "...",
    "NextActions": ["..."]
  },
  "summary": "æ±ºå®š: Approved, æœ€çµ‚ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: 30/100",
  "timestamp": "2025-11-01T00:00:00Z",
  "messageId": "uuid"
}
```

### hitl_request

```json
{
  "type": "hitl_request",
  "approvalType": "final_approval",
  "contractInfo": { ... },
  "riskAssessment": { ... },
  "promptMessage": "äº¤æ¸‰ã«ã‚ˆã‚Šç›®æ¨™ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã—ã¾ã—ãŸã€‚\nã“ã®å¥‘ç´„ã‚’æ‰¿èªã—ã¾ã™ã‹?",
  "timestamp": "2025-11-01T00:00:00Z",
  "messageId": "uuid"
}
```

### hitl_response (UI â†’ Backend)

```json
{
  "type": "hitl_response",
  "approved": true,
  "comment": "",
  "timestamp": "2025-11-01T00:00:00Z",
  "messageId": "uuid"
}
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### UI ãŒ Backend ã«æ¥ç¶šã§ããªã„

**ç—‡çŠ¶**: ã€ŒDisconnectedã€è¡¨ç¤º

**åŸå› ã¨å¯¾ç­–**:
1. Backend ãŒèµ·å‹•ã—ã¦ã„ãªã„ â†’ `dotnet run -- --websocket` ã§èµ·å‹•
2. WebSocket ãƒãƒ¼ãƒˆãŒç•°ãªã‚‹ â†’ Backend ãŒ 8080 ã§èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« â†’ localhost:8080 ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯

### HITL å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹

**ç—‡çŠ¶**: Backend ã«ã€ŒHITLå¿œç­”ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã¨è¡¨ç¤º

**åŸå› ã¨å¯¾ç­–**:
1. UI ãŒå¿œç­”ã‚’é€ä¿¡ã—ã¦ã„ãªã„ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
2. WebSocket æ¥ç¶šãŒåˆ‡ã‚Œã¦ã„ã‚‹ â†’ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç—‡çŠ¶**: UI ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› ã¨å¯¾ç­–**:
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
2. Backend ã®ãƒ­ã‚°ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’ç¢ºèª
3. WebSocket æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### UI ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´

`ui/src/app/page.tsx` ã® `renderMessage` é–¢æ•°ã‚’ç·¨é›†:

```tsx
case "agent_utterance":
  // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
  return (
    <div className="...">
      ...
    </div>
  );
```

#### è‰²ã®å¤‰æ›´

Tailwind CSS ã®ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´:

- ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: `bg-green-100`, `bg-yellow-100`, `bg-red-100`
- ãƒœã‚¿ãƒ³: `bg-green-600`, `bg-red-600`

### Backend ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°

`src/AdvancedConditionalWorkflow/Executors/*.cs` ã§ `Communication.SendAgentUtteranceAsync()` ã‚’å‘¼ã³å‡ºã™ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´:

```csharp
await Program.Communication!.SendAgentUtteranceAsync(
    agentName: "Custom Agent",
    content: "ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
    phase: "Custom Phase",
    riskScore: 50);
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

- **WebSocket æ¥ç¶š**: < 100ms
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡**: < 50ms
- **UI æ›´æ–°**: < 100ms

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

ç¾åœ¨ã®å®Ÿè£…ã¯ 1 å¯¾ 1 é€šä¿¡ã‚’æƒ³å®š:
- 1 Backend ãƒ—ãƒ­ã‚»ã‚¹
- è¤‡æ•° UI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ)

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### æœ¬ç•ªç’°å¢ƒã§ã®æ³¨æ„ç‚¹

1. **èªè¨¼ãƒ»èªå¯**: WebSocket æ¥ç¶šã«èªè¨¼ã‚’è¿½åŠ 
2. **HTTPS/WSS**: TLS æš—å·åŒ–ã‚’ä½¿ç”¨
3. **å…¥åŠ›æ¤œè¨¼**: HITL å¿œç­”ã®æ¤œè¨¼ã‚’å¼·åŒ–
4. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: DoS æ”»æ’ƒå¯¾ç­–

## ä»Šå¾Œã®æ‹¡å¼µ

- [ ] è¤‡æ•°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åŒæ™‚å®Ÿè¡Œå¯¾å¿œ
- [ ] å¥‘ç´„ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ UI
- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å±¥æ­´è¡¨ç¤º
- [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (PDF, JSON)
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
- [ ] ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [AdvancedConditionalWorkflow README](../../src/AdvancedConditionalWorkflow/README.md)
- [UI README](../../ui/README.md)
- [Common WebSocket Infrastructure](../../src/Common/WebSocket/)
- [Clean Architecture Guide](../architecture/clean-architecture.md)
