# SelectiveGroupChatWorkflow

動的エージェント選抜とモデレーターによる統合を実装したワークフローです。

## 概要

SelectiveGroupChatWorkflow は、以下の 3 つのフェーズで構成されています:

1. **Router フェーズ**: ユーザーの質問を分析し、必要な専門家を動的に選抜
2. **Specialist フェーズ**: 選抜された専門家が並列で意見を提供
3. **Moderator フェーズ**: 各専門家の意見を統合して最終回答を生成

## アーキテクチャ

```text
ユーザー質問
    ↓
┌─────────────────┐
│ Router Agent    │ ← 質問を分析し、必要な専門家を JSON 形式で選抜
└─────────────────┘
    ↓
┌─────────────────────────────────────────────────┐
│ 選抜された専門家が並列実行                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
│  │Contract │  │  Spend  │  │Sourcing │ ...  │
│  │ Agent   │  │  Agent  │  │  Agent  │      │
│  └─────────┘  └─────────┘  └─────────┘      │
└─────────────────────────────────────────────────┘
    ↓
┌─────────────────┐
│ Moderator Agent │ ← 専門家の意見を統合し、構造化された回答を生成
└─────────────────┘
    ↓
最終回答（結論・根拠・各専門家所見・次アクション）
```

## 専門家エージェント

以下の 6 つの専門家エージェントが利用可能です:

- **Contract**: 契約関連の専門家
- **Spend**: 支出分析の専門家
- **Negotiation**: 交渉戦略の専門家
- **Sourcing**: 調達戦略の専門家
- **Knowledge**: 知識管理の専門家
- **Supplier**: サプライヤー管理の専門家

## 主な特徴

### 1. 動的エージェント選抜

Router が質問内容に基づいて必要な専門家だけを選抜します。これにより:

- コストの最適化（不要な専門家を実行しない）
- 応答時間の短縮
- 関連性の高い回答の生成

### 2. 並列実行

選抜された専門家は並列で実行されるため、効率的に意見を収集できます。

### 3. モデレーターによる統合

Moderator が各専門家の意見を統合し、以下の構造化された回答を生成します:

- **結論**: 統合された結論
- **根拠**: 各専門家の意見を踏まえた根拠
- **各専門家の所見**: 専門家ごとの要約
- **次のアクション**: 推奨される次のステップ

### 4. フォールバック機能

- Router の JSON 出力がパース失敗した場合、Knowledge 専門家をデフォルトで使用
- 個別の専門家エージェントがエラーになっても、他の専門家の意見で処理を継続

### 5. OpenTelemetry 連携

ログとトレースを OpenTelemetry で収集します。OTLP エンドポイント（デフォルト `http://localhost:4317`）とコンソールに送信され、Router／各 Specialist／Moderator の実行状況と結果概要が記録されます。

## 使用方法

### 前提条件

1. Azure OpenAI サービスへのアクセス
2. Azure CLI でログイン済み（`DefaultAzureCredential` は Azure CLI 認証のみを使用）
3. 環境変数の設定:
   - `AZURE_OPENAI_ENDPOINT`: Azure OpenAI エンドポイント URL
   - `AZURE_OPENAI_DEPLOYMENT_NAME`: デプロイメント名（モデル名）

または、`appsettings.json` / `appsettings.Development.json` の `environmentVariables` セクションに設定を記載できます:

```json
{
  "environmentVariables": {
    "AZURE_OPENAI_ENDPOINT": "https://your-endpoint.openai.azure.com/",
    "AZURE_OPENAI_DEPLOYMENT_NAME": "gpt-4o"
  }
}
```

### 実行

```bash
cd src/SelectiveGroupChatWorkflow
dotnet run
```

実行後、質問を入力するプロンプトが表示されます。

### 実行例

```text
質問> 新しいサプライヤーとの契約交渉で注意すべき点は？

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ 1: ルーターが必要な専門家を選抜
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Router Agent の判断]
{
  "selected": ["Contract", "Negotiation", "Supplier"],
  "reason": "契約、交渉、サプライヤー管理の観点が必要"
}

✓ 選抜された専門家: Contract, Negotiation, Supplier
✓ 選抜理由: 契約、交渉、サプライヤー管理の観点が必要

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ 2: 選抜された専門家が並列で意見を提供
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Contract Agent の意見]
契約条項の明確化、期間、支払条件、違約金の設定が重要です...

[Negotiation Agent の意見]
事前の市場調査、条件の優先順位付け、Win-Win の関係構築を心がけましょう...

[Supplier Agent の意見]
サプライヤーの信頼性評価、実績確認、品質管理体制の確認が必要です...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ 3: モデレーターが専門家の意見を統合
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Moderator Agent が統合中...]

## 結論
新しいサプライヤーとの契約交渉では、契約条項の明確化、交渉戦略の準備、
サプライヤーの信頼性評価を総合的に実施することが重要です...

## 根拠
...

## 各専門家の所見
- **Contract**: 契約条項の明確化が最優先
- **Negotiation**: Win-Win の関係構築を目指す
- **Supplier**: サプライヤーの信頼性評価が必須

## 次のアクション
1. サプライヤーの実績・信頼性調査
2. 契約条項のドラフト作成
3. 交渉ポイントの洗い出しと優先順位付け
```

## 既存ワークフローとの比較

| 項目             | SelectiveGroupChat | DynamicGroupChat 🆕 | Handoff              | GroupChat        |
| ---------------- | ------------------ | ------------------- | -------------------- | ---------------- |
| **選抜方式**     | 事前選抜 (JSON)    | 動的ハンドオフ      | 動的ハンドオフ       | 全員参加         |
| **実行方式**     | 並列実行           | 順次ハンドオフ      | 順次ハンドオフ       | ラウンドロビン   |
| **HITL**         | ❌ なし            | ✅ Human Agent      | ❌ なし              | ❌ なし          |
| **専門家間対話** | ❌ 不可            | ✅ 可能             | ✅ 可能              | ✅ 可能          |
| **可視化**       | ❌ 困難            | ✅ 可能             | ✅ 可能              | ✅ 可能          |
| **実行速度**     | ✅ 高速            | ⚠️ やや低速         | ⚠️ やや低速          | ⚠️ 低速          |
| **柔軟性**       | ⚠️ 固定            | ✅ 動的             | ✅ 動的              | ⚠️ 固定          |
| **適用場面**     | 効率的な専門家活用 | ユーザー入力が必要  | 専門家間の対話が必要 | 全員の意見が必要 |

## 技術詳細

### 使用フレームワーク

- **Microsoft.Agents.AI.Workflows**: エージェントワークフローの構築
- **Microsoft.Extensions.AI**: AI モデルとの統合
- **Azure.AI.OpenAI**: Azure OpenAI サービスへのアクセス

### エージェント設計

各エージェントは `ChatClientAgent` として実装され、独立したワークフローとして実行されます:

- Router: 質問分析と専門家選抜を担当
- Specialists: 各専門分野の意見を提供
- Moderator: 複数の意見を統合し、構造化された回答を生成

### エラーハンドリング

- Router のパースエラー時は Knowledge 専門家をフォールバックとして使用
- 個別の専門家エラーはログに記録し、他の専門家の処理を継続
- タイムアウト設定により長時間の実行を防止

## 今後の拡張

- HITL (Human-In-The-Loop) 承認機能の統合
- 品質スコアに基づく再試行機能
- 専門家の追加・削除を設定ファイルから動的に管理
- 実行ログとテレメトリの強化
